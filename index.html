<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お弁当屋さん経営ゲーム - 注文＆日次レポート版</title>
  <style>
    /* CSS */
    #map {
      height: 400px;
      width: 100%;
    }
    #info, #storeStatus, #dailyLog {
      margin-top: 10px;
      font-size: 16px;
    }
    .button {
      padding: 10px 20px;
      font-size: 16px;
    }
    label {
      margin-right: 10px;
    }
    .store {
      margin-bottom: 10px;
      padding: 5px;
      border: 1px solid #ccc;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    /* グラフ用 */
    #salesChart {
      max-width: 100%;
      margin-top: 20px;
    }
  </style>
  <!-- config.js の読み込み -->
  <script src="config.js"></script>
  <!-- Chart.js の読み込み（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>お弁当屋さん経営ゲーム</h1>
  <!-- Google Maps 表示エリア -->
  <div id="map"></div>

  <!-- 基本情報エリア -->
  <div id="info">
    <p>クリックした位置：<span id="latlng">なし</span></p>
    <button id="buildStore" class="button" disabled>お店を建てる（建設費: 1000円）</button>
    <p>所持金: <span id="money">10000</span> 円</p>
  </div>

  <!-- 各店舗の状況・注文設定エリア -->
  <div id="storeStatus">
    <h2>各店舗の状況・注文設定</h2>
    <!-- 店舗情報と注文設定フォームがここに表示 -->
  </div>

  <!-- 日次レポートエリア -->
  <div id="dailyLog">
    <h2>日次レポート</h2>
    <table id="logTable">
      <tr>
        <th>日付</th>
        <th>シンプル 売上</th>
        <th>シンプル 廃棄</th>
        <th>贅沢 売上</th>
        <th>贅沢 廃棄</th>
        <th>健康 売上</th>
        <th>健康 廃棄</th>
        <th>総売上</th>
      </tr>
    </table>
    <!-- グラフ表示用のキャンバス -->
    <canvas id="salesChart"></canvas>
  </div>

  <!-- JavaScript：HTML、CSS、JS を1ファイルにまとめています -->
  <script>
    // Google Maps API を動的に読み込む
    function loadGoogleMapsAPI() {
      const script = document.createElement("script");
      script.src = "https://maps.googleapis.com/maps/api/js?key=" +
                   CONFIG.GOOGLE_MAPS_API_KEY + "&callback=initMap";
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    loadGoogleMapsAPI();

    // グローバル変数
    let map;
    let selectedLatLng = null;
    let funds = 10000;
    const storeCost = 1000;
    let stores = []; // 各店舗のオブジェクトを格納
    let dayCount = 1;
    // 日次総売上をグラフ表示するための配列
    let dailySalesData = [];

    // お弁当の種類ごとのデータ（仕入れコストと販売価格）
    const bentoTypes = {
      "シンプル": { salePrice: 300, cost: 200 },
      "贅沢":   { salePrice: 500, cost: 400 },
      "健康":   { salePrice: 400, cost: 300 }
    };

    // Chart.js のグラフを初期化
    let salesChart;
    function initChart() {
      const ctx = document.getElementById("salesChart").getContext("2d");
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // 日付ラベル（例: "Day 1", "Day 2", ...）
          datasets: [{
            label: '総売上',
            data: [],
            backgroundColor: 'rgba(75,192,192,0.4)',
            borderColor: 'rgba(75,192,192,1)',
            borderWidth: 1,
            fill: false,
          }]
        },
        options: {
          scales: {
            x: {
              title: {
                display: true,
                text: '日付'
              }
            },
            y: {
              title: {
                display: true,
                text: '総売上 (円)'
              },
              beginAtZero: true
            }
          }
        }
      });
    }
    initChart();

    // Google Maps の初期化（API の callback として呼ばれる）
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.6895, lng: 139.6917 },
        zoom: 10
      });
      map.addListener("click", (e) => {
        selectedLatLng = e.latLng;
        document.getElementById("latlng").textContent =
          "緯度: " + selectedLatLng.lat().toFixed(4) +
          ", 経度: " + selectedLatLng.lng().toFixed(4);
        document.getElementById("buildStore").disabled = false;
      });
    }

    // 「お店を建てる」ボタンの処理
    document.getElementById("buildStore").addEventListener("click", () => {
      if (!selectedLatLng) {
        alert("まずは地図をクリックして位置を選んでください！");
        return;
      }
      if (funds < storeCost) {
        alert("所持金が不足しています！");
        return;
      }
      funds -= storeCost;
      updateFunds();
      // 各店舗オブジェクト（注文と在庫、日次売上記録を初期化）
      const store = {
        marker: new google.maps.Marker({
          position: selectedLatLng,
          map: map,
          title: "お弁当屋さん"
        }),
        latLng: selectedLatLng,
        // 各お弁当の在庫（初期は 0 個）
        inventory: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        // 注文情報：各弁当ごとに注文個数（ユーザーが設定し、そのまま保持）
        orders: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        // 日次売上記録（累計ではなく、毎日の結果を別で保持）
        daily: { 
          "シンプル": { sold: 0, discarded: 0 },
          "贅沢": { sold: 0, discarded: 0 },
          "健康": { sold: 0, discarded: 0 }
        }
      };
      stores.push(store);
      document.getElementById("buildStore").disabled = true;
      document.getElementById("latlng").textContent = "なし";
      selectedLatLng = null;
      updateStoreStatus();
    });

    // 所持金表示更新
    function updateFunds() {
      document.getElementById("money").textContent = funds;
    }

    // 各店舗の状況・注文設定の表示更新
    function updateStoreStatus() {
      const statusDiv = document.getElementById("storeStatus");
      let html = "<h2>各店舗の状況・注文設定</h2>";
      if (stores.length === 0) {
        html += "<p>店舗はまだありません</p>";
      } else {
        stores.forEach((store, index) => {
          html += "<div class='store'>";
          html += "店舗 " + (index + 1) + "（緯度: " + store.latLng.lat().toFixed(4) +
                  ", 経度: " + store.latLng.lng().toFixed(4) + ")<br>";
          html += "現在の在庫: シンプル: " + store.inventory["シンプル"] + " 個, ";
          html += "贅沢: " + store.inventory["贅沢"] + " 個, ";
          html += "健康: " + store.inventory["健康"] + " 個<br>";
          // 現在の注文状況を表示（注文は保持され続ける）
          html += "【注文状況】 ";
          html += "シンプル: " + store.orders["シンプル"] + " 個, ";
          html += "贅沢: " + store.orders["贅沢"] + " 個, ";
          html += "健康: " + store.orders["健康"] + " 個<br>";
          // 注文フォーム：各お弁当ごとに注文数量を入力（初期値は既存の注文値）
          html += "仕入れ注文（次の日）：<br>";
          for (let type in bentoTypes) {
            html += type + "弁当: ";
            html += "<input type='number' id='order_" + type + "_" + index + "' value='" + store.orders[type] + "' min='0' style='width:60px;'> ";
          }
          html += "<button onclick='setOrder(" + index + ")'>注文確定</button>";
          html += "</div>";
        });
      }
      statusDiv.innerHTML = html;
    }

    // 注文確定ボタンの処理：店舗の注文を更新（保持される）
    function setOrder(index) {
      const store = stores[index];
      for (let type in bentoTypes) {
        const input = document.getElementById("order_" + type + "_" + index);
        store.orders[type] = parseInt(input.value, 10) || 0;
      }
      alert("店舗 " + (index + 1) + " の注文が確定しました。");
      updateStoreStatus();
    }

    // 日次レポートテーブルに行を追加
    function appendDailyLog(day, report) {
      const logTable = document.getElementById("logTable");
      let row = logTable.insertRow(-1);
      let cellDay = row.insertCell(0);
      cellDay.textContent = day;
      let cellSimpleSold = row.insertCell(-1);
      cellSimpleSold.textContent = report["シンプル"].sold;
      let cellSimpleDiscarded = row.insertCell(-1);
      cellSimpleDiscarded.textContent = report["シンプル"].discarded;
      let cellLuxSold = row.insertCell(-1);
      cellLuxSold.textContent = report["贅沢"].sold;
      let cellLuxDiscarded = row.insertCell(-1);
      cellLuxDiscarded.textContent = report["贅沢"].discarded;
      let cellHealthSold = row.insertCell(-1);
      cellHealthSold.textContent = report["健康"].sold;
      let cellHealthDiscarded = row.insertCell(-1);
      cellHealthDiscarded.textContent = report["健康"].discarded;
      let cellTotalSales = row.insertCell(-1);
      cellTotalSales.textContent = report.totalSales;
    }

    // 日次処理：1分ごとに実施（＝1日経過）
    setInterval(() => {
      // overallReport を初期化（全店舗合計）
      let overallReport = {
        "シンプル": { sold: 0, discarded: 0 },
        "贅沢": { sold: 0, discarded: 0 },
        "健康": { sold: 0, discarded: 0 },
        totalSales: 0
      };

      // 各店舗で、注文に基づく仕入れを実施（各店舗は保持中の注文内容をそのまま使用）
      stores.forEach((store) => {
        for (let type in store.orders) {
          const quantity = store.orders[type];
          const purchaseCost = bentoTypes[type].cost * quantity;
          if (funds >= purchaseCost) {
            funds -= purchaseCost;
            // 注文に応じた数量を仕入れる（既存在庫に追加）
            store.inventory[type] += quantity;
          } else {
            // 資金不足の場合は仕入れなし（在庫はそのまま）
          }
        }
        updateFunds();
      });

      // 各店舗で売上処理：各お弁当ごとに、在庫に対してランダムな需要をシミュレート
      stores.forEach((store) => {
        for (let type in store.inventory) {
          let available = store.inventory[type];
          // 売れる個数：0～available のランダムな整数
          let sold = Math.floor(Math.random() * (available + 1));
          let discarded = available - sold;
          // 日次レポート用に各店舗の日次記録に加算（※各店舗の daily は累積）
          store.daily[type].sold += sold;
          store.daily[type].discarded += discarded;
          overallReport[type].sold += sold;
          overallReport[type].discarded += discarded;
          overallReport.totalSales += sold * bentoTypes[type].salePrice;
          // 売上後、在庫はリセット（翌日仕入れのため）
          store.inventory[type] = 0;
        }
      });

      // 売上収入を所持金に加算
      funds += overallReport.totalSales;
      updateFunds();
      updateStoreStatus();

      // 日次レポートをテーブルに追加
      appendDailyLog(dayCount, overallReport);

      // グラフへもデータを追加：横軸ラベルに "Day X"、縦軸に総売上
      salesChart.data.labels.push("Day " + dayCount);
      salesChart.data.datasets[0].data.push(overallReport.totalSales);
      salesChart.update();

      dayCount++;
    }, 60000); // 60000ミリ秒＝1分

  </script>
</body>
</html>
