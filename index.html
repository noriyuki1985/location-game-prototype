<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お弁当屋さん経営ゲーム - 人口構成連動版</title>
  <style>
    /* CSS */
    #map {
      height: 400px;
      width: 100%;
    }
    #info, #storeStatus, #dailyLog {
      margin-top: 10px;
      font-size: 16px;
    }
    .button {
      padding: 10px 20px;
      font-size: 16px;
    }
    label {
      margin-right: 10px;
    }
    .store {
      margin-bottom: 10px;
      padding: 5px;
      border: 1px solid #ccc;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
  </style>
  <!-- config.js の読み込み -->
  <script src="config.js"></script>
</head>
<body>
  <h1>お弁当屋さん経営ゲーム - 人口構成連動版</h1>
  <!-- Google Maps 表示エリア -->
  <div id="map"></div>

  <!-- 基本情報エリア -->
  <div id="info">
    <p>クリックした位置：<span id="latlng">なし</span></p>
    <button id="buildStore" class="button" disabled>お店を建てる（建設費: 1000円）</button>
    <p>所持金: <span id="money">10000</span> 円</p>
  </div>

  <!-- 各店舗の状況・注文設定エリア -->
  <div id="storeStatus">
    <h2>各店舗の状況・注文設定</h2>
    <!-- 店舗情報と注文設定フォームがここに表示されます -->
  </div>

  <!-- 日次レポートエリア -->
  <div id="dailyLog">
    <h2>日次レポート</h2>
    <table id="logTable">
      <tr>
        <th>日付</th>
        <th>シンプル 売上</th>
        <th>シンプル 廃棄</th>
        <th>贅沢 売上</th>
        <th>贅沢 廃棄</th>
        <th>健康 売上</th>
        <th>健康 廃棄</th>
        <th>総売上</th>
      </tr>
    </table>
  </div>

  <!-- JavaScript：HTML、CSS、JS を1ファイルにまとめています -->
  <script>
    /* -----------------------------
       人口データのサンプル作成
       ※実際は e-Stat API で取得したデータを population.json として利用
       各オブジェクトは、ある地点の中心座標、年齢、性別、人数を表す
    ------------------------------ */
    let populationData = [
      { lat: 35.6897, lng: 139.6920, age: "30-39", gender: "male", count: 200 },
      { lat: 35.6890, lng: 139.6900, age: "40-49", gender: "male", count: 150 },
      { lat: 35.6885, lng: 139.6910, age: "50-59", gender: "female", count: 180 },
      { lat: 35.6900, lng: 139.6930, age: "60-69", gender: "female", count: 120 },
      // 他のサンプルデータを追加可能
    ];

    /* -----------------------------
       ヘルパー関数：Haversine で2点間の距離（km）を計算
    ------------------------------ */
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // 地球半径 (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /* -----------------------------
       店舗周辺（半径2km以内）の人口構成を集計する関数
       戻り値: { total: 総人口, male30_50: 男性(30～49), female50plus: 女性(50以上) }
    ------------------------------ */
    function computePopulationComposition(store) {
      let total = 0, male30_50 = 0, female50plus = 0;
      populationData.forEach(point => {
        const dist = getDistance(store.latLng.lat(), store.latLng.lng(), point.lat, point.lng);
        if (dist <= 2) {
          total += point.count;
          // 年齢の文字列で判定（簡略化のため "30-39" と "40-49" を対象）
          if (point.gender === "male" && (point.age === "30-39" || point.age === "40-49")) {
            male30_50 += point.count;
          }
          // "50-59", "60-69", 以降を女性対象とする
          if (point.gender === "female" && (point.age === "50-59" || point.age === "60-69")) {
            female50plus += point.count;
          }
        }
      });
      return { total, male30_50, female50plus };
    }

    /* -----------------------------
       売上倍率計算
       - シンプル弁当: 固定倍率 1.0
       - 贅沢弁当: 1 + (男性30-50 / 総人口)
       - 健康弁当: 1 + (女性50以上 / 総人口)
       総人口が0の場合は倍率1.0
    ------------------------------ */
    function computeMultiplier(store, type) {
      const comp = computePopulationComposition(store);
      if (comp.total === 0) return 1.0;
      if (type === "贅沢") {
        return 1 + (comp.male30_50 / comp.total);
      } else if (type === "健康") {
        return 1 + (comp.female50plus / comp.total);
      } else {
        return 1.0; // シンプル弁当
      }
    }

    /* -----------------------------
       Google Maps API の動的読み込み
    ------------------------------ */
    function loadGoogleMapsAPI() {
      const script = document.createElement("script");
      script.src = "https://maps.googleapis.com/maps/api/js?key=" +
                   CONFIG.GOOGLE_MAPS_API_KEY + "&callback=initMap";
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    loadGoogleMapsAPI();

    // グローバル変数
    let map;
    let selectedLatLng = null;
    let funds = 10000;
    const storeCost = 1000;
    let stores = []; // 各店舗オブジェクトを格納
    let dayCount = 1;
    let dailySalesData = []; // 日次総売上を記録

    // お弁当の種類ごとのデータ（仕入れコストと販売価格）
    const bentoTypes = {
      "シンプル": { salePrice: 300, cost: 200 },
      "贅沢":   { salePrice: 500, cost: 400 },
      "健康":   { salePrice: 400, cost: 300 }
    };

    /* -----------------------------
       Google Maps の初期化（API callback）
    ------------------------------ */
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.6895, lng: 139.6917 },
        zoom: 10
      });
      map.addListener("click", (e) => {
        selectedLatLng = e.latLng;
        document.getElementById("latlng").textContent =
          "緯度: " + selectedLatLng.lat().toFixed(4) +
          ", 経度: " + selectedLatLng.lng().toFixed(4);
        document.getElementById("buildStore").disabled = false;
      });
    }

    /* -----------------------------
       「お店を建てる」ボタン処理
    ------------------------------ */
    document.getElementById("buildStore").addEventListener("click", () => {
      if (!selectedLatLng) {
        alert("まずは地図をクリックして位置を選んでください！");
        return;
      }
      if (funds < storeCost) {
        alert("所持金が不足しています！");
        return;
      }
      funds -= storeCost;
      updateFunds();
      // 各店舗は、注文と在庫、日次記録を初期化
      const store = {
        marker: new google.maps.Marker({
          position: selectedLatLng,
          map: map,
          title: "お弁当屋さん"
        }),
        latLng: selectedLatLng,
        inventory: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        orders: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        daily: { 
          "シンプル": { sold: 0, discarded: 0 },
          "贅沢": { sold: 0, discarded: 0 },
          "健康": { sold: 0, discarded: 0 }
        }
      };
      stores.push(store);
      document.getElementById("buildStore").disabled = true;
      document.getElementById("latlng").textContent = "なし";
      selectedLatLng = null;
      updateStoreStatus();
    });

    /* -----------------------------
       所持金表示更新
    ------------------------------ */
    function updateFunds() {
      document.getElementById("money").textContent = funds;
    }

    /* -----------------------------
       各店舗の状況・注文設定の表示更新
    ------------------------------ */
    function updateStoreStatus() {
      const statusDiv = document.getElementById("storeStatus");
      let html = "<h2>各店舗の状況・注文設定</h2>";
      if (stores.length === 0) {
        html += "<p>店舗はまだありません</p>";
      } else {
        stores.forEach((store, index) => {
          html += "<div class='store'>";
          html += "店舗 " + (index + 1) + "（緯度: " + store.latLng.lat().toFixed(4) +
                  ", 経度: " + store.latLng.lng().toFixed(4) + ")<br>";
          html += "現在の在庫: シンプル: " + store.inventory["シンプル"] + " 個, ";
          html += "贅沢: " + store.inventory["贅沢"] + " 個, ";
          html += "健康: " + store.inventory["健康"] + " 個<br>";
          html += "【注文状況】 ";
          html += "シンプル: " + store.orders["シンプル"] + " 個, ";
          html += "贅沢: " + store.orders["贅沢"] + " 個, ";
          html += "健康: " + store.orders["健康"] + " 個<br>";
          html += "仕入れ注文（次の日）：<br>";
          for (let type in bentoTypes) {
            html += type + "弁当: ";
            html += "<input type='number' id='order_" + type + "_" + index + "' value='" + store.orders[type] + "' min='0' style='width:60px;'> ";
          }
          html += "<button onclick='setOrder(" + index + ")'>注文確定</button>";
          html += "</div>";
        });
      }
      statusDiv.innerHTML = html;
    }

    /* -----------------------------
       注文確定ボタンの処理（店舗ごと注文更新）
    ------------------------------ */
    function setOrder(index) {
      const store = stores[index];
      for (let type in bentoTypes) {
        const input = document.getElementById("order_" + type + "_" + index);
        store.orders[type] = parseInt(input.value, 10) || 0;
      }
      alert("店舗 " + (index + 1) + " の注文が確定しました。");
      updateStoreStatus();
    }

    /* -----------------------------
       日次レポートテーブルへの行追加
    ------------------------------ */
    function appendDailyLog(day, report) {
      const logTable = document.getElementById("logTable");
      let row = logTable.insertRow(-1);
      let cellDay = row.insertCell(0);
      cellDay.textContent = day;
      let cellSimpleSold = row.insertCell(-1);
      cellSimpleSold.textContent = report["シンプル"].sold;
      let cellSimpleDiscarded = row.insertCell(-1);
      cellSimpleDiscarded.textContent = report["シンプル"].discarded;
      let cellLuxSold = row.insertCell(-1);
      cellLuxSold.textContent = report["贅沢"].sold;
      let cellLuxDiscarded = row.insertCell(-1);
      cellLuxDiscarded.textContent = report["贅沢"].discarded;
      let cellHealthSold = row.insertCell(-1);
      cellHealthSold.textContent = report["健康"].sold;
      let cellHealthDiscarded = row.insertCell(-1);
      cellHealthDiscarded.textContent = report["健康"].discarded;
      let cellTotalSales = row.insertCell(-1);
      cellTotalSales.textContent = report.totalSales;
    }

    /* -----------------------------
       日次処理：1分ごとに実施（＝1日経過）
       ・各店舗で、保持された注文内容に基づき仕入れを実施。
       ・仕入れた在庫に対して、各店舗周辺の人口構成をもとに売上倍率を計算し販売。
       ・売れた個数、廃棄された個数、総売上を計算し、日次レポートに反映。
       ・仕入れ・売上後、在庫はリセット（翌日再仕入れ）。
    ------------------------------ */
    setInterval(() => {
      let overallReport = {
        "シンプル": { sold: 0, discarded: 0 },
        "贅沢": { sold: 0, discarded: 0 },
        "健康": { sold: 0, discarded: 0 },
        totalSales: 0
      };

      // 各店舗で、保持された注文内容に基づいて仕入れを実施
      stores.forEach((store) => {
        for (let type in store.orders) {
          const quantity = store.orders[type];
          const purchaseCost = bentoTypes[type].cost * quantity;
          if (funds >= purchaseCost) {
            funds -= purchaseCost;
            // 仕入れは、前日注文分を在庫に設定
            store.inventory[type] = quantity;
          } else {
            store.inventory[type] = 0;
          }
          // 注文はそのまま保持（翌日も同じ注文で仕入れ可能）
        }
        updateFunds();
      });

      // 各店舗で売上処理：各弁当ごとに、在庫に対してランダムな需要をシミュレートし、人口構成による倍率を反映
      stores.forEach((store) => {
        for (let type in store.inventory) {
          let available = store.inventory[type];
          // 基本的な売れる個数：0～available の乱数
          let baseSold = Math.floor(Math.random() * (available + 1));
          // 店舗周辺の人口構成から倍率を計算
          const multiplier = computeMultiplier(store, type);
          let sold = Math.min(available, Math.floor(baseSold * multiplier));
          let discarded = available - sold;
          store.daily[type].sold += sold;
          store.daily[type].discarded += discarded;
          overallReport[type].sold += sold;
          overallReport[type].discarded += discarded;
          overallReport.totalSales += sold * bentoTypes[type].salePrice;
          // 在庫はリセット（翌日の仕入れのため）
          store.inventory[type] = 0;
        }
      });

      funds += overallReport.totalSales;
      updateFunds();
      updateStoreStatus();
      appendDailyLog(dayCount, overallReport);
      dayCount++;
    }, 60000);

  </script>
</body>
</html>
