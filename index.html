<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お弁当屋さん経営ゲーム - 人口構成連動版</title>
  <style>
    /* CSS */
    #map {
      height: 400px;
      width: 100%;
    }
    #info, #storeStatus, #dailyLog {
      margin-top: 10px;
      font-size: 16px;
    }
    .button {
      padding: 10px 20px;
      font-size: 16px;
    }
    label {
      margin-right: 10px;
    }
    .store {
      margin-bottom: 10px;
      padding: 5px;
      border: 1px solid #ccc;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
  </style>
  <!-- config.js の読み込み -->
  <script src="config.js"></script>
</head>
<body>
  <h1>お弁当屋さん経営ゲーム - 人口構成連動版</h1>
  <!-- Google Maps 表示エリア -->
  <div id="map"></div>

  <!-- 基本情報エリア -->
  <div id="info">
    <p>クリックした位置：<span id="latlng">なし</span></p>
    <button id="buildStore" class="button" disabled>お店を建てる（建設費: 1000円）</button>
    <p>所持金: <span id="money">10000</span> 円</p>
  </div>

  <!-- 各店舗の状況・注文設定エリア -->
  <div id="storeStatus">
    <h2>各店舗の状況・注文設定</h2>
    <!-- 店舗情報と注文設定フォームがここに表示されます -->
  </div>

  <!-- 日次レポートエリア -->
  <div id="dailyLog">
    <h2>日次レポート</h2>
    <table id="logTable">
      <tr>
        <th>日付</th>
        <th>シンプル 売上</th>
        <th>シンプル 廃棄</th>
        <th>贅沢 売上</th>
        <th>贅沢 廃棄</th>
        <th>健康 売上</th>
        <th>健康 廃棄</th>
        <th>総売上</th>
      </tr>
    </table>
  </div>

  <!-- JavaScript：HTML、CSS、JS を1ファイルにまとめています -->
  <script>
    /* -----------------------------------------------------
       ① e-Stat API 生データのサンプル（population_raw.json の代替）
       ※実際は e-Stat API を呼び出して取得したデータを使用します。
    ----------------------------------------------------- */
    const estatRawData = [
      { areaCode: "11000", age: "30-39", gender: "male", count: 200 },
      { areaCode: "11000", age: "40-49", gender: "male", count: 150 },
      { areaCode: "11000", age: "50-59", gender: "female", count: 180 },
      { areaCode: "11000", age: "60-69", gender: "female", count: 120 },
      { areaCode: "13000", age: "20-29", gender: "male", count: 300 }
    ];

    /* -----------------------------------------------------
       ② geocodingData：行政区コードから中心座標への対応
       ※実際は別途取得したジオコーディングデータを利用します。
    ----------------------------------------------------- */
    const geocodingData = {
      "11000": { lat: 35.8569, lng: 139.6489 },
      "13000": { lat: 35.6895, lng: 139.6917 }
    };

    /* -----------------------------------------------------
       ③ processEstatData()：生データと geocodingData を結合し
           最終的な人口データ (populationData) を生成する
    ----------------------------------------------------- */
    function processEstatData(estatData, geocodingData) {
      let result = [];
      estatData.forEach(item => {
        const area = geocodingData[item.areaCode];
        if (area) {
          result.push({
            lat: area.lat,
            lng: area.lng,
            age: item.age,
            gender: item.gender,
            count: item.count
          });
        }
      });
      return result;
    }
    // 最終的な人口データとして利用
    let populationData = processEstatData(estatRawData, geocodingData);

    /* -----------------------------------------------------
       ヘルパー関数：Haversine で2点間の距離（km）を計算
    ----------------------------------------------------- */
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // 地球半径 (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /* -----------------------------------------------------
       computePopulationComposition()：
       店舗周辺（半径2km以内）の人口構成を集計する
       戻り値: { total: 総人口, male30_50: 男性(30-39,40-49), female50plus: 女性(50-59,60-69) }
    ----------------------------------------------------- */
    function computePopulationComposition(store) {
      let total = 0, male30_50 = 0, female50plus = 0;
      populationData.forEach(point => {
        const dist = getDistance(store.latLng.lat(), store.latLng.lng(), point.lat, point.lng);
        if (dist <= 2) {
          total += point.count;
          if (point.gender === "male" && (point.age === "30-39" || point.age === "40-49")) {
            male30_50 += point.count;
          }
          if (point.gender === "female" && (point.age === "50-59" || point.age === "60-69")) {
            female50plus += point.count;
          }
        }
      });
      return { total, male30_50, female50plus };
    }

    /* -----------------------------------------------------
       売上倍率計算：
         - シンプル弁当: 固定倍率 1.0
         - 贅沢弁当: 1 + (男性30-50 / 総人口)
         - 健康弁当: 1 + (女性50plus / 総人口)
    ----------------------------------------------------- */
    function computeMultiplier(store, type) {
      const comp = computePopulationComposition(store);
      if (comp.total === 0) return 1.0;
      if (type === "贅沢") {
        return 1 + (comp.male30_50 / comp.total);
      } else if (type === "健康") {
        return 1 + (comp.female50plus / comp.total);
      } else {
        return 1.0;
      }
    }

    /* -----------------------------------------------------
       Google Maps API の動的読み込み
    ----------------------------------------------------- */
    function loadGoogleMapsAPI() {
      const script = document.createElement("script");
      script.src = "https://maps.googleapis.com/maps/api/js?key=" +
                   CONFIG.GOOGLE_MAPS_API_KEY + "&callback=initMap";
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    loadGoogleMapsAPI();

    // グローバル変数
    let map;
    let selectedLatLng = null;
    let funds = 10000;
    const storeCost = 1000;
    let stores = []; // 各店舗オブジェクトを格納
    let dayCount = 1;
    let dailySalesData = []; // 日次総売上を記録

    // お弁当の種類ごとのデータ（仕入れコストと販売価格）
    const bentoTypes = {
      "シンプル": { salePrice: 300, cost: 200 },
      "贅沢":   { salePrice: 500, cost: 400 },
      "健康":   { salePrice: 400, cost: 300 }
    };

    /* -----------------------------------------------------
       Google Maps の初期化（API callback）
    ----------------------------------------------------- */
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.6895, lng: 139.6917 },
        zoom: 10
      });
      map.addListener("click", (e) => {
        selectedLatLng = e.latLng;
        document.getElementById("latlng").textContent =
          "緯度: " + selectedLatLng.lat().toFixed(4) +
          ", 経度: " + selectedLatLng.lng().toFixed(4);
        document.getElementById("buildStore").disabled = false;
      });
    }

    /* -----------------------------------------------------
       「お店を建てる」ボタンの処理
    ----------------------------------------------------- */
    document.getElementById("buildStore").addEventListener("click", () => {
      if (!selectedLatLng) {
        alert("まずは地図をクリックして位置を選んでください！");
        return;
      }
      if (funds < storeCost) {
        alert("所持金が不足しています！");
        return;
      }
      funds -= storeCost;
      updateFunds();
      // 各店舗オブジェクト（注文、在庫、日次記録を初期化）
      const store = {
        marker: new google.maps.Marker({
          position: selectedLatLng,
          map: map,
          title: "お弁当屋さん"
        }),
        latLng: selectedLatLng,
        inventory: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        orders: { "シンプル": 0, "贅沢": 0, "健康": 0 },
        daily: { 
          "シンプル": { sold: 0, discarded: 0 },
          "贅沢": { sold: 0, discarded: 0 },
          "健康": { sold: 0, discarded: 0 }
        }
      };
      stores.push(store);
      document.getElementById("buildStore").disabled = true;
      document.getElementById("latlng").textContent = "なし";
      selectedLatLng = null;
      updateStoreStatus();
    });

    /* -----------------------------------------------------
       所持金表示更新
    ----------------------------------------------------- */
    function updateFunds() {
      document.getElementById("money").textContent = funds;
    }

    /* -----------------------------------------------------
       各店舗の状況・注文設定の表示更新
       ※ここで、店舗ごとの人口構成データも表示
    ----------------------------------------------------- */
    function updateStoreStatus() {
      const statusDiv = document.getElementById("storeStatus");
      let html = "<h2>各店舗の状況・注文設定</h2>";
      if (stores.length === 0) {
        html += "<p>店舗はまだありません</p>";
      } else {
        stores.forEach((store, index) => {
          const comp = computePopulationComposition(store);
          html += "<div class='store'>";
          html += "店舗 " + (index + 1) + "（緯度: " + store.latLng.lat().toFixed(4) +
                  ", 経度: " + store.latLng.lng().toFixed(4) + ")<br>";
          html += "現在の在庫: シンプル: " + store.inventory["シンプル"] + " 個, ";
          html += "贅沢: " + store.inventory["贅沢"] + " 個, ";
          html += "健康: " + store.inventory["健康"] + " 個<br>";
          html += "【注文状況】 シンプル: " + store.orders["シンプル"] + " 個, ";
          html += "贅沢: " + store.orders["贅沢"] + " 個, ";
          html += "健康: " + store.orders["健康"] + " 個<br>";
          // ここで店舗周辺の人口構成データを表示
          html += "店舗周辺人口構成（半径2km以内）: 総人口: " + comp.total;
          html += ", 男性(30-49): " + comp.male30_50;
          html += ", 女性(50以上): " + comp.female50plus + "<br>";
          // 注文フォーム
          html += "仕入れ注文（次の日）：<br>";
          for (let type in bentoTypes) {
            html += type + "弁当: ";
            html += "<input type='number' id='order_" + type + "_" + index + "' value='" + store.orders[type] + "' min='0' style='width:60px;'> ";
          }
          html += "<button onclick='setOrder(" + index + ")'>注文確定</button>";
          html += "</div>";
        });
      }
      statusDiv.innerHTML = html;
    }

    /* -----------------------------------------------------
       注文確定ボタンの処理（店舗ごと注文更新）
    ----------------------------------------------------- */
    function setOrder(index) {
      const store = stores[index];
      for (let type in bentoTypes) {
        const input = document.getElementById("order_" + type + "_" + index);
        store.orders[type] = parseInt(input.value, 10) || 0;
      }
      alert("店舗 " + (index + 1) + " の注文が確定しました。");
      updateStoreStatus();
    }

    /* -----------------------------------------------------
       日次レポートテーブルへの行追加
    ----------------------------------------------------- */
    function appendDailyLog(day, report) {
      const logTable = document.getElementById("logTable");
      let row = logTable.insertRow(-1);
      let cellDay = row.insertCell(0);
      cellDay.textContent = day;
      let cellSimpleSold = row.insertCell(-1);
      cellSimpleSold.textContent = report["シンプル"].sold;
      let cellSimpleDiscarded = row.insertCell(-1);
      cellSimpleDiscarded.textContent = report["シンプル"].discarded;
      let cellLuxSold = row.insertCell(-1);
      cellLuxSold.textContent = report["贅沢"].sold;
      let cellLuxDiscarded = row.insertCell(-1);
      cellLuxDiscarded.textContent = report["贅沢"].discarded;
      let cellHealthSold = row.insertCell(-1);
      cellHealthSold.textContent = report["健康"].sold;
      let cellHealthDiscarded = row.insertCell(-1);
      cellHealthDiscarded.textContent = report["健康"].discarded;
      let cellTotalSales = row.insertCell(-1);
      cellTotalSales.textContent = report.totalSales;
    }

    /* -----------------------------------------------------
       日次処理：1分ごとに実施（＝1日経過）
       ・各店舗で保持された注文内容に基づいて仕入れを実施し、在庫を更新
       ・各店舗周辺の人口構成データから売上倍率を算出し、販売数を決定
       ・売上、廃棄、総売上を計算し、日次レポートに反映。仕入れ・売上後、在庫はリセット
    ----------------------------------------------------- */
    setInterval(() => {
      let overallReport = {
        "シンプル": { sold: 0, discarded: 0 },
        "贅沢": { sold: 0, discarded: 0 },
        "健康": { sold: 0, discarded: 0 },
        totalSales: 0
      };

      // 各店舗で、保持された注文内容に基づいて仕入れを実施
      stores.forEach((store) => {
        for (let type in store.orders) {
          const quantity = store.orders[type];
          const purchaseCost = bentoTypes[type].cost * quantity;
          if (funds >= purchaseCost) {
            funds -= purchaseCost;
            // 注文内容を在庫に設定（既存の在庫に上書き）
            store.inventory[type] = quantity;
          } else {
            store.inventory[type] = 0;
          }
          // 注文はそのまま保持（翌日も同じ注文で仕入れ可能）
        }
        updateFunds();
      });

      // 各店舗で売上処理：在庫に対してランダムな需要をシミュレートし、人口構成による倍率を反映
      stores.forEach((store) => {
        for (let type in store.inventory) {
          let available = store.inventory[type];
          let baseSold = Math.floor(Math.random() * (available + 1));
          const multiplier = computeMultiplier(store, type);
          let sold = Math.min(available, Math.floor(baseSold * multiplier));
          let discarded = available - sold;
          store.daily[type].sold += sold;
          store.daily[type].discarded += discarded;
          overallReport[type].sold += sold;
          overallReport[type].discarded += discarded;
          overallReport.totalSales += sold * bentoTypes[type].salePrice;
          // 在庫リセット（翌日の仕入れのため）
          store.inventory[type] = 0;
        }
      });

      funds += overallReport.totalSales;
      updateFunds();
      updateStoreStatus();
      appendDailyLog(dayCount, overallReport);
      dayCount++;
    }, 60000);

  </script>
</body>
</html>
